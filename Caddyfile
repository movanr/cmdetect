{
    email admin@cmdetect.de

    # Enable HTTP/3
    servers {
        protocols h1 h2 h3
    }
}

# Development Basic Auth
(dev_auth) {
    basic_auth {
        dev $2a$14$/dZPeItIHcfpa14LFLHLeun86uccqZghpH5YLJa5wysMgI778usjS
    }
}

# Common Security Headers
(security_headers) {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# Marketing Website (Protected in Dev)
{$DOMAIN}, www.{$DOMAIN} {
    import dev_auth
    import security_headers
    
    root * /opt/cmdetect/apps/marketing/dist
    file_server
    try_files {path} /index.html
    encode gzip zstd
    
    log {
        output file /opt/cmdetect/logs/caddy-marketing.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}

# Practitioner Frontend (Basic Auth for MVP - add VPN later)
app.{$DOMAIN} {
    import dev_auth
    import security_headers

    root * /opt/cmdetect/apps/frontend/dist
    file_server
    try_files {path} /index.html
    encode gzip zstd

    header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.{$DOMAIN} https://auth.{$DOMAIN} wss://api.{$DOMAIN}; font-src 'self' data:;"

    log {
        output file /opt/cmdetect/logs/caddy-app.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}

# Patient Frontend
patient.{$DOMAIN} {
    import dev_auth
    import security_headers

    root * /opt/cmdetect/apps/patient-frontend/dist
    file_server
    try_files {path} /index.html
    encode gzip zstd

    # TODO: Add rate limiting plugin later if needed

    header {
        X-Frame-Options "SAMEORIGIN"
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.{$DOMAIN} https://auth.{$DOMAIN}; font-src 'self' data:;"
    }

    log {
        output file /opt/cmdetect/logs/caddy-patient.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}

# Auth Server (PUBLIC - NO BASIC AUTH!)
auth.{$DOMAIN} {
    import security_headers

    # TODO: Add rate limiting plugin later if needed

    reverse_proxy localhost:3001 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        
        transport http {
            dial_timeout 5s
            response_header_timeout 10s
        }
    }
    
    log {
        output file /opt/cmdetect/logs/caddy-auth.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}

# Hasura API (PUBLIC - NO BASIC AUTH!)
api.{$DOMAIN} {
    import security_headers

    # TODO: Add rate limiting plugin later if needed

    # Block Admin Secret from browsers
    @has_admin_secret {
        header X-Hasura-Admin-Secret *
    }
    handle @has_admin_secret {
        respond "Forbidden" 403
    }
    
    # CORS Preflight
    @cors_preflight method OPTIONS
    handle @cors_preflight {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-Hasura-Role"
        header Access-Control-Allow-Credentials "true"
        header Access-Control-Max-Age "86400"
        respond 204
    }
    
    # Hasura Reverse Proxy
    reverse_proxy localhost:8080 {
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        
        transport http {
            dial_timeout 5s
            response_header_timeout 30s
        }
    }
    
    # CORS Response Headers (Dev: wildcard)
    header {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Credentials "true"
        Vary "Origin"
    }
    
    log {
        output file /opt/cmdetect/logs/caddy-api.log {
            roll_size 10mb
            roll_keep 5
        }
    }
}